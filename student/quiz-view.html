<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quiz â€” Rural Digital Education</title>
  <style>
    body { font-family: Nunito, sans-serif; background: #f5f7f5; padding: 20px; }
    .quiz-box { background: #fff; padding: 20px; border-radius: 10px; max-width: 700px; margin: auto; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    .question { margin: 15px 0; font-weight: 600; }
    label { display: block; margin: 5px 0; padding: 8px 12px; border-radius: 5px; cursor: pointer; border: 1px solid #ccc; }
    .correct { background-color: #d4edda; color: #155724; border-color: #28a745; }
    .wrong { background-color: #f8d7da; color: #721c24; border-color: #dc3545; }
    button { margin-top: 15px; padding: 10px 15px; background: #4a8f3c; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #3a7230; }
    #result { margin-top: 20px; font-weight: 700; text-align: center; }
    input[type="radio"] { margin-right: 8px; }
  </style>
</head>
<body>
  <div class="quiz-box">
    <h1 id="quizTitle">Quiz</h1>
    <form id="quizForm">
      <div id="questionsPlaceholder">Loading...</div>
      <button type="button" onclick="checkAnswers()">Submit Quiz</button>
    </form>
    <div id="result"></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";
    const supabaseUrl = "https://guesdqvwmybdhgejukdr.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1ZXNkcXZ3bXliZGhnZWp1a2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NTcxMDgsImV4cCI6MjA3MzQzMzEwOH0.FAG_-CBaom4LC7mKoanzFO-pi7ZZhOJE8quHO-xEsC4";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get("id");
    let quizData = [];

    async function loadQuiz() {
      const placeholder = document.getElementById("questionsPlaceholder");
      placeholder.textContent = "Loading...";

      if (!quizId) { placeholder.textContent = "Quiz id missing in URL."; return; }

      const { data, error } = await supabase
        .from("quizzes")
        .select("data")
        .eq("id", quizId)
        .single();

      if (error) { placeholder.textContent = "Error loading quiz."; console.error(error); return; }

      const qArray = data?.data;
      if (!Array.isArray(qArray) || qArray.length === 0) { placeholder.textContent = "No questions found."; return; }

      quizData = qArray;
      placeholder.remove();

      const form = document.getElementById("quizForm");

      quizData.forEach((q, idx) => {
        const qIndex = idx + 1;
        const qName = `q${qIndex}`;
        const qDiv = document.createElement("div");
        qDiv.className = "question";
        qDiv.setAttribute("data-q", qName);

        const questionText = document.createElement("div");
        questionText.textContent = `${qIndex}. ${q.question}`;
        qDiv.appendChild(questionText);

        (q.options || []).forEach(opt => {
          const label = document.createElement("label");
          label.innerHTML = `<input type="radio" name="${qName}" value="${escapeHtml(opt)}"> ${escapeHtml(opt)}`;
          qDiv.appendChild(label);
        });

        const submitBtn = form.querySelector('button[type="button"]');
        form.insertBefore(qDiv, submitBtn);
      });
    }

    function escapeHtml(str) {
      if (str == null) return "";
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'", "&#39;");
    }

    window.checkAnswers = function() {
      if (!quizData.length) return;
      let score = 0;

      document.querySelectorAll(".question").forEach((qDiv, i) => {
        const qObj = quizData[i];
        const correctAnswer = String(qObj.correctAnswer); // always string

        qDiv.querySelectorAll("label").forEach(label => {
          label.classList.remove("correct", "wrong");
          const input = label.querySelector("input");
          if (!input) return;
          const val = String(input.value);
          if (val === correctAnswer) {
            label.dataset.correct = "true"; // mark which label is correct
          } else {
            label.dataset.correct = "false";
          }
        });

        const selected = qDiv.querySelector(`input[type="radio"]:checked`);
        if (selected) {
          const selLabel = selected.parentElement;
          if (selected.value === correctAnswer) {
            selLabel.classList.add("correct");
            score++;
          } else {
            selLabel.classList.add("wrong");
            // also highlight the correct option
            const correctLabel = Array.from(qDiv.querySelectorAll("label")).find(l => l.dataset.correct === "true");
            if (correctLabel) correctLabel.classList.add("correct");
          }
        } else {
          // no selection, highlight correct
          const correctLabel = Array.from(qDiv.querySelectorAll("label")).find(l => l.dataset.correct === "true");
          if (correctLabel) correctLabel.classList.add("correct");
        }
      });

      document.getElementById("result").textContent = `Your Score: ${score}/${quizData.length}`;
      document.getElementById("result").scrollIntoView({ behavior: "smooth", block: "center" });
    };

    loadQuiz();
  </script>
</body>
</html>
